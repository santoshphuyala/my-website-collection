<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Websites Collection</title>

    <link rel="manifest" href="data:application/manifest+json,%7B%22name%22%3A%22My%20Websites%20Collection%22%2C%22short_name%22%3A%22Bookmarks%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22data%3Aimage%2Fsvg%2Bxml%2C%253Csvg%20xmlns%3D%27http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%27%20viewBox%3D%270%200%20100%20100%27%253E%253Crect%20width%3D%27100%27%20height%3D%27100%27%20rx%3D%2720%27%20fill%3D%27%25232563eb%27%2F%253E%253Cpath%20d%3D%27M30%2030%20L50%2045%20L70%2030%20L70%2070%20L30%2070%20Z%27%20fill%3D%27white%27%2F%253E%253C%2Fsvg%253E%22%2C%22sizes%22%3A%22192x192%22%7D%2C%7B%22src%22%3A%22data%3Aimage%2Fsvg%2Bxml%2C%253Csvg%20xmlns%3D%27http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%27%20viewBox%3D%270%200%20100%20100%27%253E%253Crect%20width%3D%27100%27%20height%3D%27100%27%20rx%3D%2720%27%20fill%3D%27%25232563eb%27%2F%253E%253Cpath%20d%3D%27M30%2030%20L50%2045%20L70%2030%20L70%2070%20L30%2070%20Z%27%20fill%3D%27white%27%2F%253E%253C%2Fsvg%253E%22%2C%22sizes%22%3A%22512x512%22%7D%5D%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%23f8fafc%22%2C%22theme_color%22%3A%22%232563eb%22%7D">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #f8fafc;
            --text-color: #1f2937;
            --border-color: #d1d5db;
        }
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--secondary-color);
            min-height: 100vh;
            overflow-y: scroll;
            color: var(--text-color);
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background-color: white;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .tabs {
            display: flex;
            gap: 10px;
        }
        .tab {
            padding: 8px 15px;
            cursor: pointer;
            border-radius: 6px;
            transition: background-color 0.2s;
            font-weight: 500;
        }
        .tab:hover, .tab.active {
            background-color: var(--primary-color);
            color: white;
        }
        .Backup-container {
            position: relative;
        }
        .Backup-btn {
            background-color: var(--primary-color);
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }
        #Backup {
            position: absolute;
            right: 0;
            top: 40px;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            display: none;
            flex-direction: column;
            z-index: 20;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        #Backup button {
            padding: 10px 20px;
            background: none;
            border: none;
            text-align: left;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
        }
        #Backup button:last-child {
            border-bottom: none;
        }
        #Backup button:hover {
            background-color: var(--secondary-color);
        }
        .content {
            padding: 20px;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .card-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .card {
            background: white;
            padding: 18px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }
        .card h3 {
            margin: 0 0 10px 0;
            font-size: 1.2em;
            color: var(--primary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card ul {
            list-style: none;
            padding: 0;
            margin: 10px 0 0 0;
            /* CRITICAL FIX: Ensure proper layout display */
            display: grid; 
            grid-template-columns: 1fr;
            gap: 10px;
            height: auto;
            overflow: visible;
        }
        .card li {
            padding: 8px 10px;
            background-color: var(--secondary-color);
            border-radius: 4px;
            min-height: 56px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.1s;
            cursor: grab;
            overflow-wrap: break-word; /* FIX: Prevents overflow for long names/URLs */
        }
        .card li:hover {
            background-color: #e2e8f0;
        }
        .card li a {
            flex-grow: 1;
            color: var(--text-color);
            text-decoration: none;
            font-weight: 500;
            margin-right: 10px;
            word-break: break-word;
        }
        .card li a .highlight {
            background-color: yellow;
        }
        .actions button, .btn-s, .btn-d {
            padding: 4px 8px;
            margin-left: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            transition: background-color 0.2s;
        }
        .btn-s, .add-btn {
            background-color: #3b82f6;
            color: white;
            font-weight: 600;
        }
        .btn-s:hover, .add-btn:hover {
            background-color: #2563eb;
        }
        .actions .eye {
            background-color: #fcd34d;
            color: #78350f;
        }
        .actions .eye.hidden {
            background-color: #ef4444;
            color: white;
        }
        .actions .eye:hover {
            opacity: 0.8;
        }
        .actions button {
            background-color: #e5e7eb;
            color: var(--text-color);
        }
        .actions button:hover {
            background-color: #d1d5db;
        }
        .btn-d {
            background-color: #ef4444;
            color: white;
        }
        .btn-d:hover {
            background-color: #dc2626;
        }
        .dragging {
            opacity: 0.5;
            border: 2px dashed var(--primary-color) !important;
        }

        /* Settings Page Specific Styles */
        #settingsTab {
            max-width: 800px;
            margin: 0 auto;
        }
        #settingsTab h2 {
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            margin-top: 30px;
        }
        #settingsTab input[type="search"], #settingsTab input[type="text"], #settingsTab input[type="password"], #home input[type="search"] {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
        }
        .settings-group {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-top: 20px;
        }
        .settings-group h4 {
            margin-top: 0;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
        }
        .settings-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .settings-actions button {
            padding: 10px 15px;
            font-weight: 600;
            border-radius: 4px;
            border: none;
            cursor: pointer;
        }
        #bin li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 5px;
            background: #ffe4e6;
            border-radius: 4px;
        }
        #bin li small {
            color: #7f1d1d;
            margin-left: 10px;
        }
        #lock {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        #lock div {
            background: white;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
        }
        #lock input {
            padding: 10px;
            font-size: 1.2em;
            margin: 15px 0;
            text-align: center;
            border: 2px solid var(--primary-color);
            border-radius: 4px;
            width: 150px;
        }
        .hidden-search {
            display: none;
        }
    </style>
</head>
<body>

<header>
    <div class="tabs">
        <div class="tab active" data-t="home">Home</div>
        <div class="tab" data-t="set">Settings</div>
    </div>
    <div class="Backup-container">
        <button id="backup" class="Backup-btn">Backup üîΩ</button>
        <div id="Backup">
            <button data-a="ij">Import JSON</button>
            <button data-a="ix">Import Excel</button>
            <button data-a="ej">Export JSON</button>
            <button data-a="ex">Export Excel</button>
        </div>
        <input type="file" id="file" style="display: none;">
    </div>
</header>

<div class="content">
    <div id="home" data-t="home" class="tab-content active">
        <input type="search" id="homeSearch" placeholder="Search your websites..." class="hidden-search">
        <button id="homeSearchBtn" class="btn-s" style="margin-bottom: 15px;">üîç Search Websites</button>

        <div id="homeCont" class="card-container">
            </div>
    </div>

    <div id="settingsTab" data-t="set" class="tab-content">
        <input type="search" id="search" placeholder="Search sections, links, or recycle bin...">

        <div id="setCont" class="card-container">
            </div>

        <div class="settings-group">
            <h4>Section Management</h4>
            <div class="settings-actions">
                <button id="undo" class="btn-s">Undo</button>
                <button id="redo" class="btn-s">Redo</button>
                <button id="addSec" class="btn-s">Add New Section</button>
                <button id="delAll" class="btn-d">Delete All Content</button>
            </div>
        </div>

        <div class="settings-group">
            <h4>Recycle Bin</h4>
            <ul id="bin">
                </ul>
            <div class="settings-actions">
                <button id="resAll" class="btn-s">Restore All</button>
                <button id="empBin" class="btn-d">Empty Bin</button>
            </div>
        </div>

        <div class="settings-group">
            <h4>Security (PIN)</h4>
            <input type="password" id="newP" placeholder="Enter new 4-digit PIN">
            <div class="settings-actions">
                <button id="setP" class="btn-s">Set PIN</button>
                <button id="remP" class="btn-d">Remove PIN</button>
            </div>
        </div>

        <div class="settings-group">
            <h4>Sorting</h4>
            <label><input type="radio" name="sort" value="c"> Custom Order (Drag & Drop)</label>
            <label><input type="radio" name="sort" value="a"> Alphabetical (A-Z)</label>
        </div>
    </div>
</div>

<div id="lock" style="display: none;">
    <div>
        <h2>Enter PIN to Unlock</h2>
        <input type="password" id="pinIn" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        <button id="unlock" class="btn-s">Unlock</button>
    </div>
</div>

<div>
  <footer>
    @copy 2025 Santosh Phuyal. All rights reserved.
  </footer>
</div>

<script>
const storage = {
  get: () => {
    try {
      return {
        links: JSON.parse(localStorage.getItem('links') || '{}'),
        bin: JSON.parse(localStorage.getItem('bin') || '[]'),
        pinHash: localStorage.getItem('pinHash'),
        sortMode: localStorage.getItem('sortMode') || 'a'
      };
    } catch (e) {
      console.error("[CRITICAL] Storage Error:", e);
      alert("Storage data is corrupted. Check Console.");
      return { links: {}, bin: [] };
    }
  },
  set: (links, bin = null, pinHash = null, sortMode = null) => {
    localStorage.setItem('links', JSON.stringify(links));
    if (bin !== null) localStorage.setItem('bin', JSON.stringify(bin));
    if (pinHash !== null) localStorage.setItem('pinHash', pinHash);
    if (sortMode !== null) localStorage.setItem('sortMode', sortMode);
  }
};

class BookmarkApp {
  constructor() {
    this.state = storage.get();
    this.links = this.state.links;
    this.bin = this.state.bin;
    this.pinHash = this.state.pinHash;
    this.sortMode = this.state.sortMode;
    this.undoStack = [];
    this.redoStack = [];
    this.dragged = null;
    
    console.log("APP STARTED. Loaded Links:", this.links);
    this.init();
  }

  async hashPin(pin) {
    if (!pin) return null;
    const enc = new TextEncoder();
    const data = enc.encode(pin);
    const hash = await crypto.subtle.digest('SHA-256', data);
    return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2,'0')).join('');
  }

  async checkPin(pin) {
    if (!this.pinHash) return true;
    return await this.hashPin(pin) === this.pinHash;
  }

  save() { storage.set(this.links, this.bin, null, this.sortMode); }

  pushUndo() {
    this.undoStack.push({ links: JSON.stringify(this.links), bin: JSON.stringify(this.bin) });
    if (this.undoStack.length > 50) this.undoStack.shift();
    this.redoStack = [];
  }

  undo() {
    if (!this.undoStack.length) return alert('Nothing to undo');
    this.redoStack.push({ links: JSON.stringify(this.links), bin: JSON.stringify(this.bin) });
    const state = this.undoStack.pop();
    this.links = JSON.parse(state.links);
    this.bin = JSON.parse(state.bin);
    this.save();
    this.render();
  }

  redo() {
    if (!this.redoStack.length) return alert('Nothing to redo');
    this.undoStack.push({ links: JSON.stringify(this.links), bin: JSON.stringify(this.bin) });
    const state = this.redoStack.pop();
    this.links = JSON.parse(state.links);
    this.bin = JSON.parse(state.bin);
    this.save();
    this.render();
  }

  fuzzyMatch(text, query) {
    if (!query) return true;
    const t = (text || '').toString().toLowerCase();
    const q = query.toLowerCase();
    return t.includes(q); 
  }

  highlight(text, query) {
    if (!query || !text) return text || '';
    const idx = text.toLowerCase().indexOf(query.toLowerCase());
    if (idx === -1) return text;
    return text.slice(0, idx) + `<span class="highlight">${text.slice(idx, idx + query.length)}</span>` + text.slice(idx + query.length);
  }

  // --- MODIFIED RENDER SECTIONS ---
  renderSections(containerId, query = '', showHidden = false) {
    console.group(`Rendering Container: ${containerId}`);
    const container = document.getElementById(containerId);
    if(!container) { console.error("Container not found"); return; }
    
    container.innerHTML = '';

    let sections = Object.keys(this.links);
    if (this.sortMode === 'a') {
      sections.sort((a, b) => a.localeCompare(b));
    }

    sections.forEach(sectionName => {
      const linksList = this.links[sectionName];
      console.log(`Processing Section: "${sectionName}" | Total Links in Data: ${linksList.length}`);

      const sectionMatch = this.fuzzyMatch(sectionName, query);
      const visibleLinks = linksList.filter(link => showHidden || !link.hidden);
      const hasMatchingLink = visibleLinks.some(link => 
        this.fuzzyMatch(link.name, query) || this.fuzzyMatch(link.url, query)
      );

      if (query && !sectionMatch && !hasMatchingLink) return;

      const card = document.createElement('div');
      card.className = 'card';
      card.dataset.section = sectionName;
      card.draggable = true;

      const h3 = document.createElement('h3');
      h3.innerHTML = this.highlight(sectionName, query);
      card.appendChild(h3);

      const addBtn = document.createElement('button');
      addBtn.textContent = 'Add Link';
      addBtn.className = 'btn-s add-btn';
      addBtn.onclick = () => this.addLink(sectionName);
      card.appendChild(addBtn);

      // Only show settings buttons in the settings tab
      if (containerId === 'setCont') {
        const delBtn = document.createElement('button');
        delBtn.textContent = 'Delete';
        delBtn.className = 'btn-d btn-sm';
        delBtn.onclick = () => {
          if (confirm(`Delete "${sectionName}"?`)) {
            this.pushUndo();
            this.links[sectionName].forEach(l => this.bin.push({...l, from: sectionName}));
            delete this.links[sectionName];
            this.save();
            this.render();
          }
        };
        h3.appendChild(delBtn);
      }

      const ul = document.createElement('ul');
      ul.style.display = "grid"; 
      ul.style.gridTemplateColumns = "1fr";
      ul.style.gap = "10px";
      ul.style.height = "auto"; 
      ul.style.overflow = "visible";

      let renderCount = 0;

      linksList.forEach((link, index) => {
        if (!showHidden && link.hidden) return;
        if (query && !this.fuzzyMatch(link.name, query) && !this.fuzzyMatch(link.url, query) && !sectionMatch) return;

        renderCount++;
        const li = document.createElement('li');
        li.dataset.section = sectionName;
        li.dataset.index = index;
        
        // Dragging/Drop is only enabled on the Settings tab
        if (containerId === 'setCont') {
            li.draggable = true;
        }

        const a = document.createElement('a');
        a.href = link.url;
        a.target = '_blank';
        a.innerHTML = this.highlight(link.name || 'No Name', query);
        
        // Styling for hidden links in settings
        if (link.hidden && containerId === 'setCont') {
          a.style.opacity = '0.5';
          a.style.textDecoration = 'line-through';
        }
        li.appendChild(a);

        const actions = document.createElement('div');
        actions.className = 'actions';

        if (containerId === 'setCont') {
          // Add settings actions (Edit, Delete, Eye)
          const eye = document.createElement('button');
          eye.className = 'eye' + (link.hidden ? ' hidden' : '');
          eye.innerHTML = link.hidden ? 'Hidden' : 'Visible';
          eye.onclick = e => {
            e.stopPropagation();
            this.pushUndo();
            this.links[sectionName][index].hidden = !this.links[sectionName][index].hidden;
            this.save();
            this.render();
          };
          actions.appendChild(eye);

          ['Edit','Delete'].forEach(action => {
            const btn = document.createElement('button');
            btn.textContent = action;
            btn.className = 'btn-sm';
            btn.onclick = e => {
              e.stopPropagation();
              action === 'Edit' ? this.editLink(sectionName, index) : this.deleteLink(sectionName, index);
            };
            actions.appendChild(btn);
          });
          
          li.appendChild(actions);

        } else {
            // HOME PAGE: Keep the link clickable by not adding extra actions.
            li.style.cursor = 'pointer'; // Make it look like a clickable item
        }
        
        ul.appendChild(li);

        if (containerId === 'setCont') {
            li.addEventListener('dragstart', () => { this.dragged = li; li.classList.add('dragging'); });
            li.addEventListener('dragend', () => li.classList.remove('dragging'));
            li.addEventListener('dragover', e => e.preventDefault());
            li.addEventListener('drop', () => this.handleLinkDrop(li));
        }
      });

      console.log(`   -> DOM Rendered count for ${sectionName}: ${renderCount}`);
      
      if (containerId === 'setCont') {
          card.addEventListener('dragstart', () => this.dragged = card);
          card.addEventListener('dragover', e => e.preventDefault());
          card.addEventListener('drop', () => this.handleSectionDrop(card));
      }

      card.appendChild(ul);
      container.appendChild(card);
    });
    console.groupEnd();
  }


  handleLinkDrop(targetLi) {
    if (!this.dragged || this.dragged.tagName !== 'LI') return;
    this.pushUndo();
    const fromSec = this.dragged.dataset.section;
    const fromIdx = Number(this.dragged.dataset.index);
    const toSec = targetLi.dataset.section;
    const toIdx = Number(targetLi.dataset.index);

    const moved = this.links[fromSec].splice(fromIdx, 1)[0];
    this.links[toSec].splice(toIdx + (fromSec === toSec && fromIdx < toIdx ? 1 : 0), 0, moved);
    this.save();
    this.render();
  }

  handleSectionDrop(targetCard) {
    if (!this.dragged || this.dragged === targetCard || this.dragged.tagName !== 'DIV') return;
    this.pushUndo();
    const fromSec = this.dragged.dataset.section;
    const toSec = targetCard.dataset.section;
    const keys = Object.keys(this.links);
    const fromI = keys.indexOf(fromSec);
    const toI = keys.indexOf(toSec);
    keys.splice(fromI, 1);
    keys.splice(toI, 0, fromSec);
    const newData = {};
    keys.forEach(k => newData[k] = this.links[k]);
    this.links = newData;
    this.sortMode = 'c';
    this.save();
    this.render();
  }

  renderBin(query = '') {
    const ul = document.getElementById('bin');
    ul.innerHTML = '';
    if (!this.bin.length) {
      ul.innerHTML = '<li style="color:#666;font-style:italic;background:none;">Empty</li>';
      return;
    }
    this.bin.forEach((item, i) => {
      if (query && !this.fuzzyMatch(item.name, query)) return;
      const li = document.createElement('li');
      li.innerHTML = `${this.highlight(item.name, query)} <small>from ${item.from}</small>`;
      const div = document.createElement('div');
      ['Restore','Delete'].forEach(txt => {
        const b = document.createElement('button');
        b.textContent = txt;
        b.className = txt === 'Restore' ? 'btn-s' : 'btn-d';
        b.onclick = () => txt === 'Restore' ? this.restoreItem(i) : this.permDelete(i);
        div.appendChild(b);
      });
      li.appendChild(div);
      ul.appendChild(li);
    });
  }

  render() {
    console.clear();
    console.log("--- STARTING RENDER ---");
    
    // Get search query from BOTH inputs
    const setQuery = (document.getElementById('search')?.value || '').trim();
    const homeQuery = (document.getElementById('homeSearch')?.value || '').trim();
    
    this.renderSections('homeCont', homeQuery, false);
    this.renderSections('setCont', setQuery, true);
    this.renderBin(setQuery);
    
    // FINAL DOM CHECK (kept for diagnostic summary)
    setTimeout(() => {
        const totalLis = document.querySelectorAll('#homeCont li').length;
        console.log(`[FINAL CHECK] Total 'li' elements in DOM: ${totalLis}`);
        const cardHeight = document.querySelector('.card')?.clientHeight;
        console.log(`[FINAL CHECK] First Card Height: ${cardHeight}px`);
    }, 500);
  }

  addLink(section) {
    const name = prompt('Link name:');
    if (!name?.trim()) return;
    const url = prompt('Link URL:');
    if (!url?.trim()) return;
    this.pushUndo();
    this.links[section].push({ name: name.trim(), url: url.trim(), hidden: false });
    this.save();
    this.render();
  }

  editLink(section, index) {
    const link = this.links[section][index];
    const name = prompt('Edit name:', link.name);
    const url = prompt('Edit URL:', link.url);
    if (name && url) {
      this.pushUndo();
      this.links[section][index] = { name: name.trim(), url: url.trim(), hidden: link.hidden || false };
      this.save();
      this.render();
    }
  }

  deleteLink(section, index) {
    if (!confirm('Move to recycle bin?')) return;
    this.pushUndo();
    const item = this.links[section].splice(index, 1)[0];
    this.bin.push({ ...item, from: section });
    this.save();
    this.render();
  }

  restoreItem(index) {
    this.pushUndo();
    const item = this.bin.splice(index, 1)[0];
    if (!this.links[item.from]) this.links[item.from] = [];
    this.links[item.from].push({ name: item.name, url: item.url, hidden: item.hidden || false });
    this.save();
    this.render();
  }

  permDelete(index) {
    if (!confirm('Delete permanently?')) return;
    this.pushUndo();
    this.bin.splice(index, 1);
    this.save();
    this.render();
  }

  async init() {
    if (Object.keys(this.links).length === 0) {
      console.log("No links found, initializing defaults...");
      this.links = {
        "Main": [
          {name:"FD Manager Pro",url:"https://santoshphuyala.github.io/FD-Manager-Pro/",hidden:false},
          {name:"To Do List AI",url:"https://santoshphuyala.github.io/to-do-list-ai/",hidden:false},
          {name:"Expense Manager AI",url:"https://santoshphuyala.github.io/expense-manager-AI/",hidden:false},
          {name:"My Portfolio",url:"https://santoshphuyala.github.io",hidden:false},
          {name:"GitHub",url:"https://github.com/santoshphuyala",hidden:false}
        ],
        "Tools": [
          {name:"Canva",url:"https://canva.com",hidden:false},
          {name:"Figma",url:"https://figma.com",hidden:false},
          {name:"ChatGPT",url:"https://chat.openai.com",hidden:false},
          {name:"Remove.bg",url:"https://remove.bg",hidden:false},
          {name:"TinyPNG",url:"https://tinypng.com",hidden:false}
        ],
        "Learning": [
          {name:"freeCodeCamp",url:"https://freecodecamp.org",hidden:false},
          {name:"MDN Web Docs",url:"https://developer.mozilla.org",hidden:false},
          {name:"W3Schools",url:"https://w3schools.com",hidden:false},
          {name:"YouTube",url:"https://youtube.com",hidden:false}
        ],
        "Social": [
          {name:"Gmail",url:"https://mail.google.com",hidden:false},
          {name:"Drive",url:"https://drive.google.com",hidden:false},
          {name:"Calendar",url:"https://calendar.google.com",hidden:false}
        ]
      };
      this.save();
    }

    // Tab Switching Logic
    document.querySelectorAll('.tab').forEach(t=>{
      t.onclick=()=>{
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        t.classList.add('active');
        document.getElementById('home').style.display=t.dataset.t==='home'?'block':'none';
        document.getElementById('settingsTab').style.display=t.dataset.t==='set'?'block':'none';
        
        // Hide home search when switching tabs
        document.getElementById('homeSearch').classList.add('hidden-search');
        document.getElementById('homeSearchBtn').style.display = 'inline-block';

        if(t.dataset.t==='set' && this.pinHash){
            document.getElementById('lock').style.display='flex';
            document.getElementById('settingsTab').style.display='none';
            document.getElementById('pinIn').focus();
        } else if (t.dataset.t === 'set') {
            document.getElementById('search').focus(); 
        }
      };
    });
    
    // Set up security/unlock button handlers
    if(this.pinHash){
      document.querySelector('[data-t="set"]').onclick=()=>{
        document.getElementById('lock').style.display='flex';
        document.getElementById('pinIn').focus();
      };
    }
    document.getElementById('unlock').onclick=async()=>{
        if(await this.checkPin(document.getElementById('pinIn').value)){
            document.getElementById('lock').style.display='none';
            document.getElementById('settingsTab').style.display='block';
            document.getElementById('search').focus(); 
            document.getElementById('pinIn').value = '';
        } else {
            alert('Wrong PIN');
            document.getElementById('pinIn').value = '';
            document.getElementById('pinIn').focus();
        }
    };
    
    // HOME PAGE SEARCH BUTTON & INPUT LOGIC (FIXED)
    const homeSearchBtn = document.getElementById('homeSearchBtn');
    const homeSearchInput = document.getElementById('homeSearch');

    if (homeSearchBtn) {
        homeSearchBtn.onclick = () => {
            // Show the search input and focus it
            homeSearchInput.classList.remove('hidden-search');
            homeSearchInput.focus();
            // Hide the button
            homeSearchBtn.style.display = 'none';
        };
    }

    // Trigger render/search on input change for the Home search box
    if (homeSearchInput) {
        homeSearchInput.addEventListener('input', () => this.render());
    }

    // Sorting button handlers
    document.querySelectorAll('input[name="sort"]').forEach(r=>{
      r.checked=r.value===this.sortMode;
      r.onchange=()=>{this.sortMode=r.value;this.save();this.render();};
    });

    // Action button handlers
    document.getElementById('undo').onclick=()=>this.undo();
    document.getElementById('redo').onclick=()=>this.redo();
    document.getElementById('addSec').onclick=()=>{const n=prompt('Section name:');if(!n?.trim())return;const k=n.trim();if(this.links[k])return alert('Exists');this.pushUndo();this.links[k]=[];this.save();this.render();};
    document.getElementById('delAll').onclick=()=>{if(confirm('Delete all?')){this.pushUndo();Object.values(this.links).flat().forEach(l=>this.bin.push({...l,from:'Unknown'}));this.links={};this.save();this.render();}};
    document.getElementById('resAll').onclick=()=>{if(!this.bin.length)return;if(confirm('Restore all?')){this.pushUndo();this.bin.forEach((_,i)=>this.restoreItem(0));this.bin=[];this.save();this.render();}};
    document.getElementById('empBin').onclick=()=>{if(!this.bin.length)return;if(confirm('Delete all forever?')){this.pushUndo();this.bin=[];this.save();this.render();}};

    // Security handlers
    document.getElementById('setP').onclick=async()=>{const p=document.getElementById('newP').value;if(!/^\d{4}$/.test(p))return alert('PIN must be 4 digits');storage.set(this.links,this.bin,await this.hashPin(p));alert('PIN set');document.getElementById('newP').value = ''; location.reload();};
    document.getElementById('remP').onclick=()=>{if(confirm('Remove PIN?')){storage.set(this.links,this.bin,'');alert('Removed');location.reload();}};

    // Backup handlers
    const bb=document.getElementById('backup');
    const m=document.getElementById('Backup');
    bb.onclick=e=>{e.stopPropagation();m.style.display=m.style.display==='flex'?'none':'flex';};
    document.addEventListener('click',e=>{if(!bb.contains(e.target))m.style.display='none';});

    const fi=document.getElementById('file');
    document.querySelectorAll('#Backup button').forEach(b=>{b.onclick=()=>{const a=b.dataset.a;if(a.startsWith('i')){fi.click();fi.dataset.a=a;}else if(a==='ej'){const blob=new Blob([JSON.stringify(this.links,null,2)],{type:'application/json'});const u=URL.createObjectURL(blob);const l=document.createElement('a');l.href=u;l.download='links.json';l.click();}else if(a==='ex'){const wb=XLSX.utils.book_new();Object.entries(this.links).forEach(([n,l])=>XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(l),n.slice(0,31)));XLSX.writeFile(wb,'links.xlsx');}}});

    // File import handler
    fi.onchange=e=>{
      const f=e.target.files[0];if(!f)return;
      const r=new FileReader();
      r.onload=ev=>{
        try{
          let imp={};
          if(f.name.endsWith('.json')||fi.dataset.a==='ij'){imp=JSON.parse(ev.target.result);}else{
            const wb=XLSX.read(ev.target.result,{type:'binary'});
            wb.SheetNames.forEach(s=>{const rows=XLSX.utils.sheet_to_json(wb.Sheets[s]);imp[s]=rows.map(r=>({name:r.Name||r.name||'',url:r.Url||r.url||'',hidden:!!r.Hidden||!!r.hidden})).filter(x=>x.name&&x.url);});
          }
          this.pushUndo();
          Object.entries(imp).forEach(([s,l])=>{if(!this.links[s])this.links[s]=[];l.forEach(ln=>{if(!this.links[s].some(x=>x.url===ln.url))this.links[s].push(ln);});});
          this.save();this.render();alert('Imported!');
        }catch(error){
            console.error("Import error:", error);
            alert('Import failed. Check console for details.');
        }
      };
      f.name.endsWith('.json')||fi.dataset.a==='ij'?r.readAsText(f):r.readAsBinaryString(f);
    };

    // Search input handler for Settings tab
    document.getElementById('search').addEventListener('input',()=>this.render());
    
    // Initial render
    this.render();
  }
}

new BookmarkApp();
</script>

</body>
</html>
